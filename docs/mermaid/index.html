<html>
  <head>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <py-config type="toml">
    packages = [
      "typing_extensions",
      "pyyaml",
      "rdflib",
      "pandas"
    ]
    [[fetch]]
    files = [
      "./mermaidrdf.py",
      "./kuberdf.py",
      "./app.py",
      "./ontology.ttl",
      "./d3fend-short.ttl"]
    </py-config>


    <!-- Load mermaid library -->
    <script>
        /// Load mermaid library as a js global variable accessible by pyscript.
        (async() => {
          mermaid = await import('https://cdn.jsdelivr.net/npm/mermaid@9/dist/mermaid.esm.min.mjs');
        })();
    </script>

    <!-- Styles & co -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-italia@2.3.2/dist/css/bootstrap-italia.min.css" rel="stylesheet">
    <link href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-italia@2.3.2/dist/js/bootstrap-italia.bundle.min.js"></script>
    <style type="text/css">
      .col {
        width: 50%;
        border: solid 1px;
        vertical-align: top;
      }
      textarea {
        box-sizing: content-box;
        font-family: monospace;
        font-size: 14px;
        border: solid 1px;
      }
      .result {
        width: 100%;
      }
      .dataframe {
        width: 100%;
      }
    </style>

  </head>
  <body>
    <h1>Convert a mermaid graph to RDF (experimental).</h1>


    <div class="row" style="height: 100%">



      <div class="col-sm">
          <textarea id="mermaid" style="width: 100%; height: 100%;">
graph LR

%% The simple arrow maps to d3f:accesses
Client --> WebMail

%% Font-awesome icons can be used to indicate that
%%   a node is a class (e.g. fa-react maps to a WebUI)
WebMail[WebMail fab:fa-react fa:fa-envelope]

%% Font-Awesome icons can indicate that a node
%%   accesses specific resources
%%   (e.g. fa-envelope represent a d3f:Email)
WebMail --> IMAP[IMAP fa:fa-envelope fa:fa-folder]
WebMail --> SMTP[SMTP fa:fa-envelope fa:fa-folder]
IMAP --> Mailstore[Mailstore fa:fa-envelope fa:fa-folder]

%% Associated d3f:DigitalArtifacts can be referenced via URIs too.
Authorization[d3f:AuthorizationService fa:fa-user-secret] --> |d3f:authenticates| Client
IMAP --o Authorization
SMTP --o Authorization
          </textarea>
      </div>
<div class="col-sm">
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item"><a class="nav-link active" id="tab1-tab" data-bs-toggle="tab" href="#tab1" role="tab" aria-controls="tab1" aria-selected="true">Tab 1</a></li>
    <li class="nav-item"><a class="nav-link" id="tab2-tab" data-bs-toggle="tab" href="#tab2" role="tab" aria-controls="tab2" aria-selected="false">Tab 2</a></li>
    <li class="nav-item"><a class="nav-link" id="tab3-tab" data-bs-toggle="tab" href="#tab3" role="tab" aria-controls="tab3" aria-selected="false">Tab 3</a></li>
    <li class="nav-item"><a class="nav-link" id="tab4-tab" data-bs-toggle="tab" href="#tab4" role="tab" aria-controls="tab4" aria-selected="false">Tab 4</a></li>
  </ul>
  <div class="tab-content" id="myTabContent">

    <div class="tab-pane p-4 fade" id="tab3" role="tabpanel" aria-labelledby="tab3-tab">
      <pre class="result" id="query-result" style="border-color: blue"> Results. </pre>
    </div>

    <div class="tab-pane p-4 fade show active" id="tab1" role="tabpanel" aria-labelledby="tab1-tab">
      <p id="mermaid-graph">
        graph TD

        %% The simple arrow maps to d3f:accesses
        Client --> WebMail
      </p>
    </div>

    <div class="tab-pane p-4 fade" id="tab2" role="tabpanel" aria-labelledby="tab2-tab">
      <div id="summary"> summary placeholder </div>
    </div>

    <div class="tab-pane p-4 fade" id="tab4" role="tabpanel" aria-labelledby="tab4-tab">
        <h3>Inspect the semantic graph `g`.</h3>
        <py-repl output="replOutput">
            list(g.namespaces())
        </py-repl>
        <div id="replOutput"></div>
    </div>

  </div><!-- tab-content -->

</div><!-- row -->


<py-script>
import pyodide_js
from pyodide import create_proxy
import js
import logging
log = logging.getLogger(__name__)
logging.basicConfig(level=logging.ERROR)
log.info(f"{pyodide_js.version= }")
import html
import rdflib
import pandas as pd

import mermaidrdf, kuberdf, app
from js import mermaid
log.info(f"mermaid: {dir(mermaid)}")
mermaidAPI = mermaid.default.mermaidAPI


g = app.initialize_graph(["ontology.ttl","d3fend-short.ttl"])


def on_apply(event):
  global mermaid, g
  text = code.value
  dispatch_table = {
    "mermaid": mermaidrdf.parse_mermaid,
    "kubernetes": kuberdf.parse_manifest
  }
  text_type = app.guess_content(text)
  if text_type not in dispatch_table:
    ret = (f"Unsupported content type {text_type}")
  else:
    f = dispatch_table[text_type]
    ret = f(text)
  Element("query-result").write(ret)

  log.warning("Creating summary..")
  g.parse(data=ret, format="turtle")
  rows = app.d3fend_summary(g)
  df = pd.DataFrame(data=rows[1:], columns=rows[0])
  Element("summary").write(df)


def render_mmd(event):
  """Render the `mermaid-graph` with `mermaid`.text"""
  log.warning(f"event {event}")
  text = Element("mermaid").value
  mmd = mermaidAPI.render('buz', text)
  js.document.getElementById("mermaid-graph").innerHTML = mmd


code = Element("mermaid")
tab = js.document.querySelector("li")
log.info("Found elements %r" % tab)
tab.addEventListener("click", create_proxy(on_apply))
js.document.getElementById("mermaid").addEventListener("change", create_proxy(render_mmd))

initialized = False
if not initialized:
  render_mmd(None)
  initialized = True
    </py-script>

    </body>
</html>
