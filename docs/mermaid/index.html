<html>
  <head>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <py-config type="toml">
    packages = [
      "typing_extensions",
      "pyyaml",
      "rdflib",
      "pandas"
    ]
    [[fetch]]
    files = [
      "./mermaidrdf.py",
      "./kuberdf.py",
      "./app.py",
      "./ontology.ttl",
      "./d3fend-short.ttl"]
    </py-config>


    <!-- Load mermaid library -->
    <script>
        /// Load mermaid library as a js global variable accessible by pyscript.
        (async() => {
          mermaid = await import('https://cdn.jsdelivr.net/npm/mermaid@9/dist/mermaid.esm.min.mjs');
        })();
    </script>

    <!-- Styles & co -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-italia@2.3.2/dist/css/bootstrap-italia.min.css" rel="stylesheet">
    <link href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-italia@2.3.2/dist/js/bootstrap-italia.bundle.min.js"></script>
    <style type="text/css">
      .col {
        width: 50%;
        border: solid 1px;
        vertical-align: top;
      }
      textarea {
        box-sizing: content-box;
        font-family: monospace;
        font-size: 14px;
        border: solid 1px;
      }
      .result {
        width: 100%;
      }
      .dataframe {
        width: 100%;
      }
    </style>

  </head>
  <body>
    <h1>Convert a mermaid graph to RDF (experimental).</h1>
    <p>Enter a mermaid graph in the left textarea, and click on the left tabs to see the D3FEND Summary and the RDF graph that can
    be imported on a SPARQL/Neo4j servers for further analysis</p>

    <div class="row" style="height: 100%">



      <div class="col-sm">
          <textarea id="mermaid" style="width: 100%; height: 100%;">
graph LR

%% The simple arrow maps to d3f:accesses
Client --> WebMail

%% Font-awesome icons can be used to indicate that
%%   a node is a class (e.g. fa-react maps to a WebUI)
WebMail[WebMail fab:fa-react fa:fa-envelope]

%% Font-Awesome icons can indicate that a node
%%   accesses specific resources
%%   (e.g. fa-envelope represent a d3f:Email)
WebMail -->|fa:fa-envelope| IMAP[IMAP fa:fa-envelope fa:fa-folder]
WebMail -->|fa:fa-envelope| SMTP[SMTP fa:fa-envelope fa:fa-folder]
IMAP --> Mailstore[Mailstore fa:fa-envelope fa:fa-folder]

%% Associated d3f:DigitalArtifacts can be referenced via URIs too.
Authorization[d3f:AuthorizationService fa:fa-user-secret] --> |d3f:authenticates| Client
IMAP --o Authorization
SMTP --o Authorization
          </textarea>
      </div>
<div class="col-sm">
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item"><a class="nav-link active" id="tab1-tab" data-bs-toggle="tab" href="#tab1" role="tab" aria-controls="tab1" aria-selected="true">Mermaid</a></li>
    <li class="nav-item"><a class="nav-link" id="tab2-tab" data-bs-toggle="tab" href="#tab2" role="tab" aria-controls="tab2" aria-selected="false">D3FEND</a></li>
    <li class="nav-item"><a class="nav-link" id="tab3-tab" data-bs-toggle="tab" href="#tab3" role="tab" aria-controls="tab3" aria-selected="false">RDF graph</a></li>
    <li class="nav-item"><a class="nav-link" id="tab4-tab" data-bs-toggle="tab" href="#tab4" role="tab" aria-controls="tab4" aria-selected="false">Console</a></li>
    <li class="nav-item"><a class="nav-link" id="tab5-tab" data-bs-toggle="tab" href="#tab5" role="tab" aria-controls="tab5" aria-selected="false">Help</a></li>
  </ul>
  <div class="tab-content" id="myTabContent">


    <div class="tab-pane p-4 fade show active" id="tab1" role="tabpanel" aria-labelledby="tab1-tab">
      <p id="mermaid-graph">
        graph TD

        %% The simple arrow maps to d3f:accesses
        Client --> WebMail
      </p>
    </div>

    <div class="tab-pane p-4 fade" id="tab2" role="tabpanel" aria-labelledby="tab2-tab">
      <div id="summary"> summary placeholder </div>
    </div>

    <div class="tab-pane p-4 fade" id="tab3" role="tabpanel" aria-labelledby="tab3-tab">
      <pre class="result" id="graph-turtle" style="border-color: blue"> Results. </pre>
    </div>

    <div class="tab-pane p-4 fade" id="tab4" role="tabpanel" aria-labelledby="tab4-tab">
        <p>Inspect the semantic graphs `g` and `g1`.</p>
        <py-repl output="replOutput">
            list(g.namespaces())
        </py-repl>
        <div id="replOutput"></div>
    </div>

    <div class="tab-pane p-4 fade" id="tab5" role="tabpanel" aria-labelledby="tab5-tab">
        <p>This tools shows a possible usage of the D3FEND ontology to support the design and review of IT architectures.

        **Note that mermaid graph is not rendered automatically. You need to click on the Mermaid tab to refresh it.**

        <ul>
        <li>The first step is to represent your components and their relationships in a mermaid graph.
        <li>You can classify your components using font-awesome icons (see the <a href="https://fontawesome.com/icons?d=gallery">gallery</a>). For example the <code>fa:fa-envelope</code> icon is used to reference is an email.

        <pre>Client -->|fa:fa-envelope| MTA</pre>

        The application is capable to label major sofware applications (e.g. nginx, postfix, ...) and to map them to the corresponding D3FEND classes (e.g. <code>d3f:MailTransferAgent</code>).

        You can also use the <code>fab:fa-react</code> icon to indicate that a component is a WebUI.

        <li>Once you have created your mermaid graph, you can click on the D3FEND tab to see the corresponding D3FEND graph. The D3FEND graph is represented as a turtle file. You can copy and paste it in your favorite RDF editor (e.g. <a href="https://www.w3.org/RDF/Validator/">W3C RDF validator</a>).

        <li>The "Summary" tab shows a table with the main entities of the D3FEND graph and the attacks associated with the specific DigitalArtifacts. The table contains hyperlinks to the corresponding D3FEND classes and ATT&CK techniques.
        </p>
    </div>

  </div><!-- tab-content -->

</div><!-- row -->
<py-script>
import pyodide_js
from pyodide import create_proxy
import js
import logging
from time import time
log = logging.getLogger(__name__)
logging.basicConfig(level=logging.ERROR)
log.info(f"{pyodide_js.version= }")
import html
import rdflib
import pandas as pd

import app
from js import mermaid
log.info(f"mermaid: {dir(mermaid)}")
mermaidAPI = mermaid.default.mermaidAPI


g = app.initialize_graph(["ontology.ttl","d3fend-short.ttl"])
g1 = None
text0 = None

def on_apply(event):
  """Create the RDF graph from mermaid text,
    update the turtle representation
    and the summary table.
  """
  global g, g1, text0
  if text0 == Element("mermaid").value:
    log.warning("No change in mermaid text.")
    return
  text0 = Element("mermaid").value

  log.warning("Creating RDF graph..")
  t0 = time()
  graph_ttl = app.content_to_rdf(Element("mermaid").value)
  Element("graph-turtle").write(graph_ttl)
  log.warning("Created RDF graph in %d.." % (time()-t0,))

  log.warning("Creating summary..")
  t0 = time()
  g1 = rdflib.Graph()
  g1.parse(data=graph_ttl, format="turtle")
  html = app.d3fend_summary_html(g + g1)
  log.warning("Created summary in %d.." % (time()-t0,))

  summary = Element("summary")
  summary.clear()
  summary.element.innerHTML = html


def render_mmd(event):
  """Render the `mermaid-graph` with `mermaid`.text"""
  log.warning(f"event {event}")
  text = Element("mermaid").value
  mmd = mermaidAPI.render('buz', text)
  js.document.getElementById("mermaid-graph").innerHTML = mmd


code = Element("mermaid")
tab = js.document.querySelectorAll("li.nav-item")
log.info("Found elements %r" % tab)
[x.addEventListener("click", create_proxy(on_apply)) for x in tab]
js.document.getElementById("mermaid").addEventListener("change", create_proxy(render_mmd))

initialized = False
if not initialized:
  render_mmd(None)
  initialized = True
    </py-script>

    </body>
</html>
