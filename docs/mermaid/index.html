<html>
  <head>
    <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-italia@2.3.2/dist/css/bootstrap-italia.min.css" rel="stylesheet">
<!--
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-italia@2.3.2/dist/js/bootstrap-italia.bundle.min.js"></script>
-->
    <py-env>
      - typing_extensions
      - rdflib
      - pyyaml
      - paths:
        - ./mermaidrdf.py
        - ./kuberdf.py
        - ./app.py
        - ./ontology.ttl
        - ./d3fend-short.ttl
    </py-env>
    <style type="text/css">
      .col {
        width: 50%;
        border: solid 1px;
        vertical-align: top;
      }
      textarea {
        box-sizing: content-box;
        font-family: monospace;
        font-size: 14px;
        border: solid 1px;
      }
      .result {
        width: 100%;
      }
      .dataframe {
        width: 100%;
      }
    </style>
        <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@9/dist/mermaid.esm.min.mjs';
      mermaid.initialize({ startOnLoad: true });
    </script>
  </head>
  <body>
    <h1>Convert a mermaid graph to RDF (experimental).</h1>

    <div>
        <textarea id="mermaid" style="width: 100%; height: 20em;">
graph TD

%% The simple arrow maps to d3f:accesses
Client --> WebMail

%% Font-awesome icons can be used to indicate that
%%   a node is a class (e.g. fa-react maps to a WebUI)
WebMail[WebMail fab:fa-react fa:fa-envelope]

%% Font-Awesome icons can indicate that a node
%%   accesses specific resources
%%   (e.g. fa-envelope represent a d3f:Email)
WebMail --> IMAP[IMAP fa:fa-envelope fa:fa-folder]
WebMail --> SMTP[SMTP fa:fa-envelope fa:fa-folder]
IMAP --> Mailstore[Mailstore fa:fa-envelope fa:fa-folder]

%% Associated d3f:DigitalArtifacts can be referenced via URIs too.
Authorization[d3f:AuthorizationService fa:fa-user-secret] --> |d3f:authenticates| Client
IMAP --o Authorization
SMTP --o Authorization
        </textarea>
    </div>
    <div id="mermaid-graph">
      <div class="mermaid">
      graph TD

      %% The simple arrow maps to d3f:accesses
      Client --> WebMail
 

      </div>
    </div>
    <button id="apply" style="color: white; background-color: blue; width: 100%">Query.</button>
    <div class="row" >
      <div class="col-sm">
          <pre class="result" id="query-result" style="border-color: blue">
              Results.
          </pre>
      </div>
      <div class="col-sm" id="summary">
        summary placeholder
      </div>
    </div>

<py-script>
import html
import logging
import yaml
from rdflib import Graph
import js
log = logging.getLogger()

from pyodide import create_proxy
import mermaidrdf, kuberdf, app

g = Graph()
log.info("Loading ontologies...")
# g.parse("ontology.ttl", format="turtle")
# g.parse("d3fend-short.ttl", format="turtle")
log.info("Loaded ontology")

def guess_content(text):
  """Guess the content type of the text: mermaid or kubernetes manifest."""
  test = text.strip()
  if test.startswith("graph"):
    return "mermaid"
  if any(("kind" in x for x in yaml.safe_load_all(test))):
    return "kubernetes"
  return None


def on_apply(event):
  global mermaid, g
  text = code.value
  dispatch_table = {
    "mermaid": mermaidrdf.parse_mermaid,
    "kubernetes": kuberdf.parse_manifest
  }
  text_type = guess_content(text)
  if text_type not in dispatch_table:
    ret = (f"Unsupported content type {text_type}")
  f = dispatch_table[text_type]
  turtle = f(text)
  g.parse(data=turtle, format="turtle")
  Element("query-result").write(html.escape(turtle))
  log.warning("Creating summary..")
  Element("summary").write(app.d3fend_summary(g))

# Create an element with pyscript


def copy_text(event):
  log.warning(f"event {event}")
  text = Element("mermaid").value
  mermaid_graph = js.document.createElement("div")
  mermaid_graph.classList.add("mermaid")
  mermaid_graph.innerHTML = text
  document.getElementById("mermaid-graph").appendChild(mermaid_graph)


def create_f(query):
  return lambda event: Element("mermaid").write(query)

code = Element("mermaid")
button = document.querySelector("button")
button.addEventListener("click", create_proxy(on_apply))
document.getElementById("mermaid").addEventListener("change", create_proxy(copy_text))




if False:

  for button_id, query in sparql.QUERIES.items():
    log.info("button_id" + button_id)
    b = document.querySelector(f'#{button_id}')
    if not b:
      log.info("button not found")
      continue
    # log.warning("Button %r", dir(b))
    b.innerHTML = query["label"]
    b.addEventListener("click", create_proxy(create_f(query["query"])))

    </py-script>


    </body>
</html>
